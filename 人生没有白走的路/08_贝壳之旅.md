# 贝壳之旅

## Freeday

- 延长年假特批流程
- 假期的业务逻辑
    - 调休假逻辑修改，6个月过期，如何扣假等等
    - WFH提报限制，一个月不可申请2天，一年累计不超过10天
    - 哺乳假，用户直接选开始和结束日期，默认在所选周期内每天休一小时
    - 根据性别区分能选什么假期
        - 如判断是男性，则下拉框中无产假、哺乳假、产检假
        - 如判断是女性，则下拉框中无陪产假
    - WFH跨年请假，把第二年的天数累加到今年的累计天数里
    - 应届生的特殊假期逻辑
        - 社会工作起始时间不满1年，视为应届生
        - 应届生自入职起至社会工作起始时间满1年前，年假基数为0（可能需要清空部分数据）
        - 应届生社会工作起始时间满1年后至当年年底，基数为10，按当年剩余在我司天数折算，一次发放
        - 应届生社会工作起始时间满1年后次年1/1起，一次发放年假11天，每逢1/1加1天，上限为15天
    - 试用期员工的特殊处理，不能申请年假
    - 增加倒休假假种
    - 特殊假期处理，因疫情影响，导致的假期性质改动，比如1.31,2.1改成带薪假期，不算出勤
    - 因审核顺序导致假期扣除顺序混乱，致使销假发生异常
        - 保证用户利益最大化，出现此类情况后，把该请假时间点之后的假期重新都算一遍
    - 请假的时间跨了过期时间，比如年假跨了3月31日，还要分段进行比较
    - 撤销年假时，如果年假已经过期了，给提示，但是不退回
    - 成都职场组织架构调整
    - Freeday增加假期过期时间，原来6个月，但现在可以自由调整
        - 用户查看个人调休假时的过期时间调整
        - 调休假报表导出的过期时间调整
        - 调休假请假扣除顺序调整
        - 销假的假期退还逻辑调整
        - 清空过期调休假的定时任务调整
        - 相应测试用例调整
    - 加班时间过期依然可用于扣除过期前申请的调休假
    - 请调休假时判断是否有足够时长可扣除（需考虑过期）
    - 提交调休假的分段扣除逻辑，用户一共有3天调休假，分别在8/3、8/4和8/5过期。在8/3之前，用户申请了这三天的调休假，但系统提示请假日期超出调休假的使用时效，请修改后重新提交。
    - 如果审批多条，前端的loading不生效
    - 请假/加班/销假审批拒绝时增加确认提示
- 加班的业务逻辑
    - 若覆盖了中午午休一小时，加班结束时间延长1小时
- 请假列表页面
    - 支持搜索
- 休假和加班的变更明细页面
    - 利用history看特定时间段的变更
- 用户个人中心
    - 增加剩余可用带薪病假和已用带薪病假
- 技术支持
    - 增加休假的history表，引入history库
    - 给定时任务增加分布式锁
    - 假期数据异常检测工具的编写。为了确保线上数据的准确性，防止意外的异常出现，诸如重复扣假、漏扣等等，需要有脚本定期去检测用户的休假数据与请假/加班是否一致。
    - 经常有人换签，要把他们标志位离职
    - 企微连续审批，导致高并发场景下，第二次的请假未被扣除。
- 第三方对接
    - uc对接，增加离职的状态，并结合报表导出时间判断是否导出该用户数据
- 请假数据导入
    - 导入员工初始的假期数据
    - 理房通初始假期数据导入
    - 假期数据虚拟化
- 请假报表导出
    - 请假加班导出
        - 各种请假的时长，每种假期有不同的计算方式，病假（正常计薪病假，非正常计薪病假），年假（去年年假，法定年假，福利年假），工作日加班，休息日加班，节日加班
        - 支持按统计周期搜索，以及按城市搜索
    - 年假调休导出
        - 统计全年休假，已用和剩余数值，过期时间
        - 统计法定年假，福利年假的全年，已用，可用时间，剩余时间
    - 在途请假记录导出
        - 导出所有状态为“请假审批”“销假待审批”及“等待审批”的请假/加班记录。
    - 报表导出各项优化
        - 报表导出增加loading——Done
        - 增加报表导出全量测试用例——Done
        - 完善报表导出的相关文档——Done
        - 优化接口执行性能——Done
        - 报表导出的获取假期管理信息不通过全局变量的方式去获取——Done
        - 完善法定年假折算逻辑，统一写法，重点关注应届生转非应届生的情况——Done
        - 报表导出年假导出逻辑重构。目前的实现过于复杂，可读性差。从可读性、可维护性、可测试性、模块化等角度去优化代码——已保证基本的可读可测试可维护，持续优化
- 增加一键打开关闭wfh限制的功能
- 线上异常处理
    - 因企微审批未执行后续的假期表更新等操作，导致线上数据一致性发生问题，针对各种假期，修复方案如下：
    - 加班：vacation表里增加今年可使用调休时间target_overtime_hours
    - 年假：增加vacation表里的已使用年假，优先扣除去年年假。对应年假记录的extra_info字段里，填上扣除说明，格式：{"2019": 2.0, "2020": 1.0}
    - 调休：增加vacation表里的今年已使用调休时间used_target_overtime_hours，扣除加班表里的可用时长（按加班日期依次扣），对应的调休假记录的extra_info字段里，填上扣除说明，格式：{"515": 2, "645": 6}，键名为加班记录的id
    - wfh：更新vacation表里的 wfh数据
    - 病假：更新vacation表里的已发生病假数
    - 无薪事假：更新vacation表里的无薪事假
- 理房通和成都组织架构调整
- freeday数据迁移
    - 年假余额
    - 加班余额
    - 带薪病假余额
    - 12月请假记录
    - 11月前的请假流水
    - 11月前的假期汇总
    - 请假开关
    - 12月份禁止申请wfh和倒休假


## tonic

工单提交
- 表单模块设计
    - 多个分类，业务类型，附件类型
    - 各种情况的复杂场景
- 附件模块设计
    - 附件查看
    - 下载，区分预览和下载
    - 一键下载压缩包
    - 附件列表
    - 附件权限
    - 图片附件在线预览，使用组件，懒加载
    - 附件前端表单设计
    - 附件后端模块设计
        - 附件model
        - 通用viewset
        - 批量瞎子啊
    - 前端组件创新：拦加载
- 工单详情页
    - 工单展示
    - 工单编辑
        - 基础信息修改
        - 附件信息修改
    - 工单历史记录
- 工单状态流转
    - 工单驳回支持贴图
- 工单列表页
    - 工单导出excel
- 审核模块
    - 通用，收入类
- EBS模块
    - 操作历史记录
    - 存量EBS的导入
    - EBS的接口对接
    - 不同的分类，不同的搜索
- 批量导入凭证编号和日记账号的对应关系
- 税务类工单
    - 表单设计
    - 权限设计
    - 菜单设计
    - 报表导出
- 问题反馈模块
    - 问题反馈工单列表/工单详情 已关闭    
    - 问题反馈类工单领取逻辑/转单逻辑 CANCELLED
    - 工单状态流转 已关闭
    - 提报人可取消已上报的问题 已关闭
    - 提交人确认工单是否解决及评价 已关闭
    - 经办人领取处理工单 已关闭
    - 数据分析-工单数据分析 已关闭
    - 问题反馈详情页——工单跟进记录 已关闭
    - 问题反馈详情页——工单跟进记录 已关闭
    - 问题反馈详情页——工单编辑 已关闭
    - 经办人处理问题 已关闭
    - 工单状态流转——各按钮权限管理 已关闭
    - 问题反馈详情页——历史详情 已关闭
    - 问题反馈列表页——领取&转单 已关闭
    - 问题反馈列表页——快捷按钮添加 已关闭
    - hotpot数据迁移 已关闭
    - 工单评价分析
- celery业务优化
    - 增加celery-result-backend
    - 脚本管理功能改为使用celery period task执行
    - 48小时自动完成增加默认评价
- tonic登录界面优化
    - 自动添加ke用户
- 薪酬录入模块
    - 上传文件
    - 列表查询

## OA

- 采购模块CEO审批问题流程配置
- IT服务申请单问题分类增设
- 印章保管人更新
- IT服务申请单问题分类增设
- 印章保管人更新
- 理房通OA变更协议字段调整
- OA邮件权限移交
- OA页面接口方案调研
    - 方案一：模拟登录。因涉及到session无法获取到的问题，并且oa页面的接口功能有限，该方案选择放弃
    - 方案二：二次开发，需要把表结构关系研究透，花费的功夫多。但是这种方法比较灵活，可满足后续的功能开发需求
- OA流程菜单接口开发
    - oa增加的family的菜单接口
    - 获取任务数目接口
    - 获取任务列表接口
- 文章公告审核
    - 申请单创建
    - 金融之家sdk
    - 二次开发
- 流程中涉及到的人或岗的排查

## 金融之家
- 菜单和流程模块
    - 获取OA的数据
    - 整合BPM的数据
    - 流程缓存与搜索
- 文章管理
    - 作者，可见返回修改
- OA数据隔离
    - 获取数据
    - 工厂模式
    - xxl-job任务
- 文章公告审核
    - 数据表创建
    - 给OA提供的接口
- 消息通知模块
- 用户行为模块
- 考勤管理模块
    - 查询年假明细，余额明细
- 理房通企微同步
    - 企微静默登录
    - 人员同步管理
- 资源位和大事件的整合
- 花名册导出
    - 同步人员
    - 报表导出