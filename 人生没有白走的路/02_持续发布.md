# 持续集成

## 背景

在开发完AWS资源申请管理系统后，我紧接着负责部门持续发布的相关工作。

这对我来说一个巨大的挑战，我刚刚回顾了自己当年写的设计文档，非常的头皮发麻。

在我介入之前，部门已经有了持续构建系统，集成测试系统，预生产部署系统，生产部署系统。但是它们之间彼此独立，毫无关联，我的职责就是把这些串联起来，做持续发布。

## 亮点

我觉得我主要解决了以下部门痛点：

### 1. 新增大版本号的概念，打通所有流程

因为部门是分布式的业务，每个模块都有自己的版本号，我需要确定一个大版本号，去包括起来各个小版本号，同时包括当前数据库情况，测试代码情况等等

有了大版本号，就可以统一的去做集成测试，预生产发布，以及生产发布。

### 2. 集成各个系统

确立了大的方案，然后需要把各个系统连接起来。

于是开发了版本发布系统，专门与各个系统进行对接。

对于持续构建系统，需要的是从中拉取各个模块的各个版本信息

对于持续集成系统，需要管理各个集成测试环境当前部署的版本情况，以及调用持续集成系统的部署接口

对于预生产发布系统，需要把大版本信息告知它，并且调用相应的部署&测试接口

对于生产发布，需要把大版本信息告知它，调用相应的接口

### 3. 提高上线效率

在没有版本发布系统之前，部门各个系统之前完全独立，每次上线，需要开发人员去找相应的系统负责人做构建、集成测试、预生产发布、生产发布等，过程非常的繁琐。

版本发布系统的诞生解决了这一困扰，可以由开发人员在统一的界面上去申请集成测试、预生产发布和生产发布。而且把原来线下的过程全部线上化，提升了效率，方便了管理。

### 4. 提高自动化水平

持续发布的一个目标就是实现自动化，虽然部门已经有了一些工具来实现自动化的集成测试、预生产更新，但只是半自动化，未实现全流程的自动化。

其中的一个痛点就是测试环节，测试必须要人工的去跑，必然会有中断。持续发布的一个创新点是，把测试代码也作为上线模块的一个版本，在自动化部署时，测试代码也进行相应的版本部署，这样可以把部署和测试连成一个整体。

于是达到了这样的效果，在预生产发布环境，总体实现了一键部署，只要开发人员点一个启动按钮，便会依次触发更新和测试，若通过则进入下一环节，不需要人为的处理或等待。


## 不足

### 1. 限制太多，反而难自由发挥

因为对业务本身的缺乏了解，大版本的出现实际上给更新发布带来了很多限制。

在部分更新场景下，实际上是不需要大版本号的概念的，会让某些更新变得很死板。

### 2. 过分要求自动化，系统设计复杂

自动化是系统的一个目标，

### 3. 没有前瞻性视野

当时的设计开发，很多还是基于部门目前的技术栈和更新方式，没有提出更有创新性的想法。
比如，没有想过引入docker

### 4. 烟囱式的系统，未能成为整体

虽然把诸多系统的功能结合在一起，但对一些基础信息没有统一管理的思路。
每当新增一个新的模块时，需要再各个系统中依次添加，造成了很多麻烦。
应当有专门的服务去对于特定的内容进行管理

### 5. 太强调代码版本，忽视了更新中其他的细节

一次更新所涉及到的方方面面实在是太多了，代码版本是一方面，其他的，比如数据库的更新，AWS新资源的申请也是非常重要的，另外，按照原有设定的思路（先更新数据库，再自底而上的去更新各个模块），在一些特殊情况，会违反这个更新顺序，导致必要时需要人工介入。

因为这些因素，还是不能保证一次更新百分之百的自动化。

## 反思总结

这是一个很大的项目，涉及到的面很广，在我职业生涯初期遇到这样的一个任务，说实话我是招架不住的，结果也证明，至少我觉得很不理想。

现在再让我去思考17年做的事情，我觉得还可以有以下方向进行改进优化

### 成长型思维

年轻的时候，不知道如何把任务分解。因为项目很大，涉及到部门的方方面面，对于当时学生思维浓厚的我，是非常艰难的一个任务。

不会沟通，不会定计划，缺少成长型思维，这些都成了制约项目良性发展的最大隐患。

### 通用设计

做项目总想着一步达成目标，却不知道其实可以把目标拆成一个个的小目标，逐条完成。

因为目标太单一，才导致了所有的资源都往那边靠，形成了过拟合的现象。做出的产品虽然在一定程度上满足了需要，也说得过去，但是在可扩展性方面就差多了。

如果重新来一次，我希望不要急于求成，而是先理清楚现状。什么才是重要不紧急的事情，把它们有规划的去完成。

比如，有一个服务可以统一管理各个模块的版本，避免系统间的相互调用。
比如，可以把部署相关的操作，比如启动ami，部署服务，更新版本等等，封装成具体的一个个接口，在实际调用的过程中具体去选择，而不是一整个大接口去做所有的事情。

### 可扩展性

接上，为了应对更新的复杂性，必须把更新的颗粒度足够细，才能有利于业务上的定制。

我因为错误的事先规划出了一个更新模板，才导致了系统所支持的更新策略极为有限，很多时候不得不人工介入。

### 拒绝害羞

在系统做了快一半的时候，我总感觉自己做的很差，但不太爱沟通，怕被否定，所以就花了很大的时间继续按原有的想法做。

其实，哪个需求的优先级高，哪个需求可以调整为另一个形式，我是没有去跟同事们沟通的。这是我做的非常不好的地方，对于现在的我来说，我不会再犯了。

杜绝任何一个破窗。